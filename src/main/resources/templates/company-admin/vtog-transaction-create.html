<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>기업 - V2G 거래 등록</title>
  <link rel="shortcut icon" href="https://wabiz-static-dev.s3.ap-northeast-2.amazonaws.com/static/favicon/favicon.png" type="image/x-icon" />
  <link rel="stylesheet" href="/css/common/font.css" />
  <link rel="stylesheet" href="/css/common/reset.css" />
  <link rel="stylesheet" href="/css/common/common.css">
  <link rel="stylesheet" href="/css/common/fontawesome.css">
  <link rel="stylesheet" href="/css/common/util.css" />
  <link rel="stylesheet" href="/css/company-admin/company-charger.css" />
  <link type="text/css" th:href="@{/css/company-admin/top.css}" rel="stylesheet" />
  <link type="text/css" th:href="@{/css/company-admin/menu-flex.css}" rel="stylesheet" />
</head>
<body>

<div th:replace="~{/company-admin/top::top}" style="margin-bottom: 20px;"></div>

<main class="board">
  <div class="ui-header" style="max-width: 600px; width: 100%; margin: 0 auto; padding: 24px 24px 0 24px; box-sizing: border-box;">
    <h2 class="title">V2G 거래 등록</h2>
  </div>

  <div class="board-main" style="padding: 24px; display: flex; justify-content: center;">
    <form th:action="@{/vtog/transaction/insert}"
          method="post"
          id="mainForm"
          style="max-width: 600px; width: 100%;">

      <!-- hidden 필드 -->
      <input type="hidden" id="memberId"      name="memberId"      value="">
      <input type="hidden" id="memberAddress" name="memberAddress" value="">

      <!-- ① 회원 조회 -->
      <p style="font-size: 15px; font-weight: bold; color: #4a90e2; margin-bottom: 12px;">① 회원 조회</p>

      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">회원 이메일</label>
        <div style="display: flex; gap: 8px; height: 45px;">
          <input type="email" id="memberEmail"
                 placeholder="이메일을 입력하세요"
                 autocomplete="off"
                 style="flex: 1; height: 45px; padding: 0 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
          <button type="button" onclick="searchMember()"
                  style="height: 45px; padding: 0 16px; background: #333; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; white-space: nowrap;">
            조회
          </button>
        </div>
        <p style="font-size: 13px; color: #888; margin-top: 4px;">이메일로 회원을 조회하세요. 조회 후 아래 항목이 활성화됩니다.</p>
        <p id="memberError" style="color: #e74c3c; font-size: 13px; margin-top: 4px;"></p>
        <div id="memberInfoBox" style="display: none; background: #f0f7ff; border: 1px solid #b3d4f5; border-radius: 6px; padding: 12px 16px; margin-top: 8px; font-size: 14px;">
          <div style="display: flex; gap: 12px; margin-bottom: 4px;"><span style="font-weight: bold; min-width: 80px; color: #555;">이름</span><span id="infoName"></span></div>
          <div style="display: flex; gap: 12px; margin-bottom: 4px;"><span style="font-weight: bold; min-width: 80px; color: #555;">이메일</span><span id="infoEmail"></span></div>
          <div style="display: flex; gap: 12px; margin-bottom: 4px;"><span style="font-weight: bold; min-width: 80px; color: #555;">주소</span><span id="infoAddress"></span></div>
          <div style="display: flex; gap: 12px;"><span style="font-weight: bold; min-width: 80px; color: #555;">회원 ID</span><span id="infoId"></span></div>
        </div>
      </div>

      <hr style="border: none; border-top: 2px dashed #ddd; margin: 24px 0;">

      <!-- ②③④ 회원 조회 후 활성화 -->
      <div id="insertSection" style="display: none;">

        <!-- ② 차량 등록 -->
        <p style="font-size: 15px; font-weight: bold; color: #4a90e2; margin-bottom: 12px;">② 차량 등록</p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">차량 번호판</label>
          <input type="text" id="carPlateNumber" name="carPlateNumber"
                 placeholder="예) 12가 3456" required
                 style="width: 100%; height: 45px; padding: 0 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
          <p style="font-size: 13px; color: #888; margin-top: 4px;">차량 번호판을 입력하세요.</p>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">차량 수전 에너지 용량 (kWh)</label>
          <input type="number" id="carEnergyGauge" name="carEnergyGauge"
                 placeholder="예) 60" min="1" required
                 style="width: 100%; height: 45px; padding: 0 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
          <p style="font-size: 13px; color: #888; margin-top: 4px;">차량이 수전할 수 있는 에너지 용량을 입력하세요.</p>
        </div>

        <hr style="border: none; border-top: 2px dashed #ddd; margin: 24px 0;">

        <!-- ③ 충전기 조회 -->
        <p style="font-size: 15px; font-weight: bold; color: #4a90e2; margin-bottom: 12px;">③ 충전기 조회</p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">충전기 번호 (UID)</label>
          <div style="display: flex; gap: 8px; height: 45px;">
            <input type="text" id="evChargerUid" name="evChargerUid"
                   placeholder="예) CHARGER-001" autocomplete="off"
                   style="flex: 1; height: 45px; padding: 0 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            <button type="button" onclick="searchCharger()"
                    style="height: 45px; padding: 0 16px; background: #333; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; white-space: nowrap;">
              조회
            </button>
          </div>
          <p style="font-size: 13px; color: #888; margin-top: 4px;">등록된 충전기 번호를 입력 후 조회하세요.</p>
          <p id="chargerError" style="color: #e74c3c; font-size: 13px; margin-top: 4px;"></p>
          <div id="chargerInfoBox" style="display: none; background: #f0fff4; border: 1px solid #b3f5c8; border-radius: 6px; padding: 12px 16px; margin-top: 8px; font-size: 14px;">
            <div style="display: flex; gap: 12px; margin-bottom: 4px;"><span style="font-weight: bold; min-width: 80px; color: #555;">충전기 ID</span><span id="infoChargerId"></span></div>
            <div style="display: flex; gap: 12px;"><span style="font-weight: bold; min-width: 80px; color: #555;">충전기 UID</span><span id="infoChargerUid"></span></div>
          </div>
        </div>

        <hr style="border: none; border-top: 2px dashed #ddd; margin: 24px 0;">

        <!-- ④ 거래 정보 -->
        <p style="font-size: 15px; font-weight: bold; color: #4a90e2; margin-bottom: 12px;">④ V2G 거래 등록</p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">판매 가능한 전기 용량 (kWh)</label>
          <input type="number" id="salesKwh" name="vtogPaymentSalesKwh"
                 placeholder="예) 30" min="1" required
                 style="width: 100%; height: 45px; padding: 0 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
          <p style="font-size: 13px; color: #888; margin-top: 4px;">판매 가능한 전기 용량을 입력하세요.</p>
        </div>

        <div style="margin-bottom: 28px;">
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">V2G 전력 판매 금액 (원)</label>
          <input type="number" id="salesPrice" name="vtogPaymentSalesPrice"
                 placeholder="예) 15000" min="1" required
                 style="width: 100%; height: 45px; padding: 0 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
          <p style="font-size: 13px; color: #888; margin-top: 4px;">전력 판매 금액을 입력하세요.</p>
        </div>

        <!-- 버튼 -->
        <div style="display: flex; gap: 8px;">
          <input type="button"
                 value="취소"
                 onclick="location.href='/vtog/transaction/list'"
                 style="flex: 1; height: 45px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; cursor: pointer; color: #333;">
          <input type="submit"
                 value="등록 완료"
                 onclick="return validateForm()"
                 style="flex: 1; height: 45px; background: #333; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 600;">
        </div>

      </div><!-- /insertSection -->

    </form>
  </div>
</main>

<script>
  function searchMember() {
    const email = document.getElementById('memberEmail').value.trim();
    const errorEl = document.getElementById('memberError');
    const infoBox = document.getElementById('memberInfoBox');
    const insertSection = document.getElementById('insertSection');

    errorEl.textContent = '';
    infoBox.style.display = 'none';
    insertSection.style.display = 'none';
    document.getElementById('memberId').value = '';
    document.getElementById('memberAddress').value = '';

    if (!email) { errorEl.textContent = '이메일을 입력해주세요.'; return; }

    fetch('/vtog/transaction/member?email=' + encodeURIComponent(email))
            .then(res => { if (!res.ok) throw new Error(); return res.json(); })
            .then(member => {
              if (!member || !member.id) {
                errorEl.textContent = '해당 이메일의 회원을 찾을 수 없습니다.';
                return;
              }
              document.getElementById('infoName').textContent    = member.memberName    || '-';
              document.getElementById('infoEmail').textContent   = member.memberEmail   || '-';
              document.getElementById('infoAddress').textContent = member.memberAddress || '-';
              document.getElementById('infoId').textContent      = member.id;
              document.getElementById('memberId').value          = member.id;
              document.getElementById('memberAddress').value     = member.memberAddress || '';

              infoBox.style.display       = 'block';
              insertSection.style.display = 'block';
            })
            .catch(() => { errorEl.textContent = '회원 조회 중 오류가 발생했습니다.'; });
  }

  function searchCharger() {
    const uid = document.getElementById('evChargerUid').value.trim();
    const errorEl = document.getElementById('chargerError');
    const infoBox = document.getElementById('chargerInfoBox');

    errorEl.textContent = '';
    infoBox.style.display = 'none';

    if (!uid) { errorEl.textContent = '충전기 번호를 입력해주세요.'; return; }

    fetch('/vtog/transaction/charger?evChargerUid=' + encodeURIComponent(uid))
            .then(res => { if (!res.ok) throw new Error(); return res.json(); })
            .then(charger => {
              if (!charger || !charger.id) {
                errorEl.textContent = '존재하지 않는 충전기 번호입니다.';
                return;
              }
              document.getElementById('infoChargerId').textContent  = charger.id;
              document.getElementById('infoChargerUid').textContent = charger.evChargerUid;
              infoBox.style.display = 'block';
            })
            .catch(() => { errorEl.textContent = '충전기 조회 중 오류가 발생했습니다.'; });
  }

  document.getElementById('memberEmail').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); searchMember(); }
  });

  function validateForm() {
    if (!document.getElementById('memberId').value) {
      alert('회원 조회를 먼저 완료해주세요.');
      return false;
    }
    if (!document.getElementById('chargerInfoBox').style.display ||
            document.getElementById('chargerInfoBox').style.display === 'none') {
      alert('충전기 조회를 먼저 완료해주세요.');
      return false;
    }
    return true;
  }
</script>
</body>
</html>
